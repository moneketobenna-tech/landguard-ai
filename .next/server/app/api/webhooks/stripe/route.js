"use strict";(()=>{var e={};e.id=798,e.ids=[798],e.modules={517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},2081:e=>{e.exports=require("child_process")},6113:e=>{e.exports=require("crypto")},2361:e=>{e.exports=require("events")},3685:e=>{e.exports=require("http")},5687:e=>{e.exports=require("https")},3837:e=>{e.exports=require("util")},7287:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>k,originalPathname:()=>v,patchFetch:()=>E,requestAsyncStorage:()=>m,routeModule:()=>f,serverHooks:()=>b,staticGenerationAsyncStorage:()=>S,staticGenerationBailout:()=>y});var o={};r.r(o),r.d(o,{POST:()=>w,dynamic:()=>d});var n=r(5419),s=r(9108),a=r(9678),i=r(8070),u=r(1211),l=r(895),c=r(6521),p=r.n(c);let d="force-dynamic",h=new u.Z(process.env.STRIPE_SECRET_KEY||"",{apiVersion:"2023-10-16"}),g=process.env.STRIPE_WEBHOOK_SECRET||"";async function w(e){try{let t;let r=await e.text(),o=e.headers.get("stripe-signature");if(!o)return i.Z.json({error:"Missing signature"},{status:400});try{t=g?h.webhooks.constructEvent(r,o,g):JSON.parse(r)}catch(e){return console.error("[Webhook] Signature error:",e),i.Z.json({error:"Invalid signature"},{status:400})}switch(console.log(`[Webhook] Event: ${t.type}`),t.type){case"checkout.session.completed":{let e=t.data.object,r=e.customer_email,o=e.customer;if(!r){console.error("[Webhook] No email in session");break}let n=await (0,l.CX)(r);if(!n){let e=function(){let e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%",t="";for(let r=0;r<16;r++)t+=e[Math.floor(Math.random()*e.length)];return t}(),t=await p().hash(e,12);n=await (0,l.r4)(r,t),console.log(`[Webhook] Created new user: ${r}`)}await (0,l.D0)(n.id,"pro",o),console.log(`[Webhook] Upgraded user to Pro: ${r}`);break}case"customer.subscription.deleted":{let e=t.data.object.customer;console.log(`[Webhook] Subscription cancelled for customer: ${e}`)}}return i.Z.json({received:!0})}catch(e){return console.error("[Webhook] Error:",e),i.Z.json({error:"Webhook failed"},{status:500})}}let f=new n.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/webhooks/stripe/route",pathname:"/api/webhooks/stripe",filename:"route",bundlePath:"app/api/webhooks/stripe/route"},resolvedPagePath:"C:\\Users\\Toby\\Desktop\\landguard-ai\\app\\api\\webhooks\\stripe\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:m,staticGenerationAsyncStorage:S,serverHooks:b,headerHooks:k,staticGenerationBailout:y}=f,v="/api/webhooks/stripe/route";function E(){return(0,a.patchFetch)({serverHooks:b,staticGenerationAsyncStorage:S})}},895:(e,t,r)=>{r.d(t,{CX:()=>c,D0:()=>p,G3:()=>d,GA:()=>l,r4:()=>u});var o=r(4409);let n=new Map,s=new Map,a=null;async function i(){return a||(process.env.KV_REST_API_URL&&process.env.KV_REST_API_TOKEN?a=(0,o.eI)({url:process.env.KV_REST_API_URL,token:process.env.KV_REST_API_TOKEN}):null)}async function u(e,t){let r=e.toLowerCase().trim(),o="lg_"+Date.now().toString(36)+Math.random().toString(36).slice(2),a={id:o,email:r,passwordHash:t,planType:"free",licenseKey:function(){let e="ABCDEFGHJKLMNPQRSTUVWXYZ23456789",t=[];for(let r=0;r<4;r++){let r="";for(let t=0;t<4;t++)r+=e[Math.floor(Math.random()*e.length)];t.push(r)}return t.join("-")}(),createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()},u=await i();return u?(await u.set(`user:${o}`,JSON.stringify(a)),await u.set(`email:${r}`,o)):(n.set(o,a),s.set(r,o)),a}async function l(e){let t=await i();if(t){let r=await t.get(`user:${e}`);return r?"string"==typeof r?JSON.parse(r):r:null}return n.get(e)||null}async function c(e){let t=e.toLowerCase().trim(),r=await i();if(r){let e=await r.get(`email:${t}`);return e?l(e):null}let o=s.get(t);return o&&n.get(o)||null}async function p(e,t,r){let o=await l(e);if(!o)return null;o.planType=t,r&&(o.stripeCustomerId=r),o.updatedAt=new Date().toISOString();let s=await i();return s?await s.set(`user:${e}`,JSON.stringify(o)):n.set(e,o),o}function d(e){if(!e)return"";let t=e.split("-");return 4!==t.length?"****-****-****-****":`${t[0]}-****-****-${t[3]}`}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[638,206,409,521,211],()=>r(7287));module.exports=o})();